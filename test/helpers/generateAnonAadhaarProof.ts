import {
  AnonAadhaarProof,
  ArtifactsOrigin,
  artifactUrls,
  generateArgs,
  init,
  InitArgs,
  PackedGroth16Proof,
  packGroth16Proof,
  prove
} from '@anon-aadhaar/core';
import fs from 'fs';

// Data generated in the anon-aadhaar repo, to have freshly signed data
// https://github.com/anon-aadhaar/anon-aadhaar/blob/main/packages/circuits/scripts/generateTestData.ts
const testQRData =
  '8259163575998395410294216884136380469956696873129743080468375299050490833602936127948238559406607004538775188409831748779392239887612871424792570349254650301851805068066173775118081304632846064144696131643880983400968844960693107889378999391195587352213353099893044851975398483336281526772970638357500763740347144303872364933562912765543423856203069514694634616552489696545795808200830749901010500195714556595091932765249211126797808759788730757990682911756189222817480242512939461400142571139580638141455278862960314883504831841111597657106273286458740738773804059489826798233885929757956596567190886902006063029785869612272266172526735887356223437265191745618622909436552526404015735254298774140957673197700663548111857539535018127872538822678533624595782202038186768360618124481322482776371743393902377763510732388745200440447248299799161548878594997280270553878603222365039323433517178497282680690722915835924586164241949734124643651588158881252584274044226629216663780544640993671367925494929403481966583074245200236827603583050121936194800832939055708677260094412235441592956069005470922198095428034929371807849999244677448225405615676804267321253986140562518867213411353633443523186439313029869731297620536970994992536766212624234141361688931779070715228555603810419275701839414329385626150446458366659466140537675121536985523622570756215659960286197716828904327718369910912090833235722361300208995966443676547517249366868438132713205466534707691608632551434323108593267311217281053263466560526285184658282851580359589861484822532354040925791571908806077962511757283295025371763236849361475124442779474477265489581731773187449976205318422214796673471085891067092160728509594650997189778676241746518913887954139431327136742412419166218429600769219210386338517312644245566907455150900637757065625056582871974106806830877653852385601966465724833017698600579700100917703017547098401135427912107647311935159807468630853106183558279191347050845982087793109149340493389282541954692232891865457164447450438377074578116413741374274786886766097325061043599060052386091138252833099592471729138909941923067978961150928717720056272926331339388603892315587070619221989866108763827861993077833738514497030657342148701890515041689499153454013063822750374030295699133226126484207062155733993373053817326427180285112406773789668861515463389074638077846594680766286535960739533866937986854191079761397791201863932697426647767834432344012734116240971778032529533627410123491044291964899120305414016650858509365351484055365681829422194078492519878665795081980607158961492155401750352078429095758499540576414292801312930552464799492995172288542848163556857389308192474365774388017670084413933917070056073580993875175070349505320653813148523318051355802178034081697573296313517732700520323858095301734708381564684418914741521324662270653664819451159173617593902903035525260819246516334953801232366020962026009975573793507888062336296735547297133173503159239191898080400122375343802362771199964442084210749343213373175032613266158138339971246665875224019834278068513847714647717742242359522752510714321454122168600614222041137730698638815316523741083117933234063772121021397868492899655';

export async function generateAnonAadhaarProof(
  nullifierSeed: number,
  signal: string
): Promise<{
  anonAadhaarProof: AnonAadhaarProof;
  packedGroth16Proof: PackedGroth16Proof;
}> {
  const certificateDirName = __dirname + '/../../assets';
  const certificate = fs.readFileSync(certificateDirName + '/testCertificate.pem').toString();

  const anonAadhaarInitArgs: InitArgs = {
    wasmURL: artifactUrls.v2.wasm,
    zkeyURL: artifactUrls.v2.zkey,
    vkeyURL: artifactUrls.v2.vk,
    artifactsOrigin: ArtifactsOrigin.server
  };

  await init(anonAadhaarInitArgs);

  const args = await generateArgs({
    qrData: testQRData,
    certificateFile: certificate,
    nullifierSeed: nullifierSeed,
    signal: signal,
    fieldsToRevealArray: ['revealAgeAbove18', 'revealGender', 'revealPinCode', 'revealState']
  });

  const anonAadhaarCore = await prove(args);

  const anonAadhaarProof = anonAadhaarCore.proof;

  const packedGroth16Proof = packGroth16Proof(anonAadhaarProof.groth16Proof);

  return { anonAadhaarProof, packedGroth16Proof };
}
