import {
  AnonAadhaarProof,
  ArtifactsOrigin,
  artifactUrls,
  generateArgs,
  init,
  InitArgs,
  PackedGroth16Proof,
  packGroth16Proof,
  prove
} from '@anon-aadhaar/core';
import fs from 'fs';

// Data generated in the anon-aadhaar repo, to have freshly signed data
// https://github.com/anon-aadhaar/anon-aadhaar/blob/main/packages/circuits/scripts/generateTestData.ts
const testQRData =
  '695108307045527203055615552134508634869313570552660469095912985299885657878597916394294818583008512303432828329065974414314109960621981387777863254126527420930406986193560589508589672469675418488146196356222080417002386990080403933030707318627305116451966079711640554988409487617610350302912683688833750426224249734710498017228893601277610875432313049633979391587262571451169293971187333151405147117123707387417567097274244753021118550061335469250457285365265641801072248935327914689789281342939466695599512444580223600754027983956614267182282138244152137302304456951334822410415910003364134249034129295611706120983063423967835636178910826698757251178643948709459042523646535844744153038837123982012192293189012125496769876203422303959167739924627637495382582127138877204903095990510709541071975906186285155855651172252566861148154493367938794048830324616194040447482130419723834285406494038799402551370384064393071531009565577424354887395202845199004417346998081343612709591161869699533715517344972164546997644025640521325367344953276899063991771863818712636434599669830952127416858537079376959859333959464536326417380222764554944014833442786819540108641312165252490814506192053266134047880199676797557879530848768670547556404255386100262365298348187109232757323746159450487702753919691460016561852283019898844569393602199282102451537719656499298684318636377540383202163120473694785025487977691216420665240879942464776000726614740632088689139299766753450050316264199138115657106318168689611997671328513178064800644810718802561369119232457944431854601963211214616165435351978255977606932395068752267220154943255800120927612357577605557637409328618892212246265511274548570056716028395589581679007225435729361640487327095174435480421035062704343171456612030746937296689778923966018863652486671041467550429324555913053459488903988894441665957596472636784391456367324276103642421916099690010432480554162731323417352662407109975830552515234601041125362491155293958323795307752120311722128121299007750524592940798303030383462156976069205065460169187305953997752486396713318991783768629653351437277253577874654579127113692064145453925655693602882279319671846814534176501202296973123109007808656408645083267407219828440862645527012054692001916261534249366799502881694353287267198775347124490181355017841908207340400659248475353972999221886012668999638320813756932081293559889842982194447646280514890234366072788506542959790822369117822959983839976765178545085580129771547818115632612459427766453490090166066553510470725499238323336236345468465102611870082192691175802058109931818969308921412215447410118292462908961059367069295248026371214432689035449484045830967977837295908578907802379346689447556324055780630114315432034882524373053629585250154637573486070885989977019604882437052780115222980212100652020151473860841903667690880340045742948257445658782361723289426482912170696211671440013903747556177607217229659198540186327722635072729325587059467617011498739084268836829378730204317532272242749638714696600877581169738002231485805041141000819229508754162766979739166310121107996520597093123110910008163414890406012917068833055616255397257416908648236386207778075443385795490527420857273270136882592329713684090497809999706329885281667046185424837165456414783086249284859329604826428425070316295438913541492029566345628162824822568466234209369610818561511557270825418398135343609127806';

export async function generateAnonAadhaarProof(
  nullifierSeed: number,
  signal: string
): Promise<{
  anonAadhaarProof: AnonAadhaarProof;
  packedGroth16Proof: PackedGroth16Proof;
}> {
  const certificateDirName = __dirname + '/../../assets';
  const certificate = fs.readFileSync(certificateDirName + '/testCertificate.pem').toString();

  const anonAadhaarInitArgs: InitArgs = {
    wasmURL: artifactUrls.v2.wasm,
    zkeyURL: artifactUrls.v2.zkey,
    vkeyURL: artifactUrls.v2.vk,
    artifactsOrigin: ArtifactsOrigin.server
  };

  await init(anonAadhaarInitArgs);

  const args = await generateArgs({
    qrData: testQRData,
    certificateFile: certificate,
    nullifierSeed: nullifierSeed,
    signal: signal,
    fieldsToRevealArray: ['revealAgeAbove18', 'revealGender', 'revealPinCode']
  });

  const anonAadhaarCore = await prove(args);

  const anonAadhaarProof = anonAadhaarCore.proof;

  const packedGroth16Proof = packGroth16Proof(anonAadhaarProof.groth16Proof);

  return { anonAadhaarProof, packedGroth16Proof };
}
