import {
  AnonAadhaarProof,
  ArtifactsOrigin,
  artifactUrls,
  generateArgs,
  init,
  InitArgs,
  PackedGroth16Proof,
  packGroth16Proof,
  prove
} from '@anon-aadhaar/core';
import fs from 'fs';

// Data generated in the anon-aadhaar repo, to have freshly signed data
// https://github.com/anon-aadhaar/anon-aadhaar/blob/main/packages/circuits/scripts/generateTestData.ts
const testQRData =
  '695108307045527203055615552134508634869313570552656633514121189585146933376121494520685575006066910818218965485412799576384552746520167874865833718355812718826943364171856147537003705234060483054341281026287451847187112690859175708420364491992960215040572231842729945714991621978484816021856298691998791194801236638904426433465401616858989000037652607869170423989318382712975086350783639509457558413958112861422878726788728642155242732454054291826332076969905076202223401479497926258162265906797959988553275774213871036305277405024132982932791544521325609511808756850901783922344628097333395221345840165088980109574367186778219043394761892020301137152447903562636073348861802160765578909486100451650420795678741481879055029304180687789750705136879285942056496568126160850842630706368863499881815299691934431242341837158001146340638036957462852589915681666172065749128599717941703264667377322649185736930503299977772443625583191881810823278241692038986799528237886853641212940950285697787397478507159482448908517282654581487570578345476207649485521755876551447541924560530696853971645340878329287102738399673240244740516000374048993625655739769379883672149271527372061380159675917379822727350758336996791772986494914860597763330050674605309696593389111718869661807913113924415633845432525140453646534000057523115322521015326124760507449691623710300707411901718285617299050575623368645766773019382933949833192673709422860330520500482972503737335504371924944799590968304517741481071525848487805286175572023015893120116245657289141758605010422701002480050824266100817709772788979060549077752777826956555869351498723001142158928210119555150438325129041713426595600381036921809821114656068043305999315424420270771519580264080373046469899179683203259335762991560493130599849031904658044209558747257626590718941336089180817866334070558165209403315760883690531227336399470701743097552097478315359770724652246554560706917657114422474412313489937392107555455303227364103329865770381918596327236697621485258002920111346706050109589284311085134491656086951082936504315025543157183678932157836309471472554953131578889055190305986430296279355730889189031354215814128257755478366711023178089567675438268999736934985254572114672157234610371729082058124120886916699170696745640744359282089615226107079840613454750275156562203779729059836860804913059119753560040029984456835286941279913943164675452705826686047204056381488436052431691929787939368272597403813724298043659044362482287541706302600289789429423048634940992683513259685171158191569849861815518671162327838530112606798949318729912071378398795518102648928609109919128579769043794221853020360029724030310006983377092667338595368285742997188916924409601414873189122218071929321396756843978705860479642262590423019701456537708014325867632300039914309185353539148622192552788474806840490487979634795757187154669035625369909586842657297116045302024370110101736118654041783076256130110827517128326038683888127679704605996162917255283100196029286766153642103831519488760479807438613306214314353987681519772530498355743045488762235816305683776645317617285936655197756901430426693666509257302193335103081847171946458679792509246437751737984086137886712225128211212635103188528834691906485620339028411590886736440839569675268645736475689306334069833409410346984623031998402130867388392841216452790385033777029382955856949874507991951444033589741462789';

export async function generateAnonAadhaarProof(
  nullifierSeed: number,
  signal: string
): Promise<{
  anonAadhaarProof: AnonAadhaarProof;
  packedGroth16Proof: PackedGroth16Proof;
}> {
  const certificateDirName = __dirname + '/../../assets';
  const certificate = fs.readFileSync(certificateDirName + '/testCertificate.pem').toString();

  const anonAadhaarInitArgs: InitArgs = {
    wasmURL: artifactUrls.v2.wasm,
    zkeyURL: artifactUrls.v2.zkey,
    vkeyURL: artifactUrls.v2.vk,
    artifactsOrigin: ArtifactsOrigin.server
  };

  await init(anonAadhaarInitArgs);

  const args = await generateArgs({
    qrData: testQRData,
    certificateFile: certificate,
    nullifierSeed: nullifierSeed,
    signal: signal,
    fieldsToRevealArray: ['revealAgeAbove18', 'revealGender', 'revealPinCode', 'revealState']
  });

  const anonAadhaarCore = await prove(args);

  const anonAadhaarProof = anonAadhaarCore.proof;

  const packedGroth16Proof = packGroth16Proof(anonAadhaarProof.groth16Proof);

  return { anonAadhaarProof, packedGroth16Proof };
}
