import {
  AnonAadhaarProof,
  ArtifactsOrigin,
  artifactUrls,
  generateArgs,
  init,
  InitArgs,
  PackedGroth16Proof,
  packGroth16Proof,
  prove
} from '@anon-aadhaar/core';
import fs from 'fs';

// Data generated in the anon-aadhaar repo, to have freshly signed data
// https://github.com/anon-aadhaar/anon-aadhaar/blob/main/packages/circuits/scripts/generateTestData.ts
const testQRData =
  '2114345875455589225035319522338913400308914399521118829085386804935756702503627602575588852948495181226743527468104025965115146939322358596661615811284600587581857693901229365685835149475318624794648232821636899262743676467920515418799430478087777539115629694457805882963323075997848946820466551491232805214980362140043288379133500355502212402580811300609919770823055414071820345541115262997098180448681701613740014974462996472370469707495049062348580807084749769337268098025038374326144126235065782286538016537182557992928254587906333687540614488870185316423467332373811945074829856250880604731238681314813230377437148652549339047464704476648760033685705066095304336307567341525718704847334894152947709385244323154471237576542635376712411514220215174928198229032643298594482853426865922033704025947150848203027248103021561389019479664714055531724260868210022574420976447465965677855278530429508079433231076679791585028772988293715388952595687727997635612332889824828361793762107143295707430451962847077081310990662366493750277938086721002212711423211203005649933155540087079603756769932438218438683283891396827058991558324379831716573224174839971321755648004577394271589673499697389939005721263868382316879391056114555026510522063275512829568546589671737661534512034253733494198071506268269754995956978088050610714244326181287007889483024401067960925784002587412753391086483253694559560522427468203017456202511830197548316080855520684296602231834906988151572825777302696545357737450510915807469390598074788505550350442738616480823549274203064950836790510381491612718470189881584597402635461867730016527749875373137675078406578402193459679675919386806577273303948007731112532927976666775223021220357944253139932707534749143161899664559188731149047062298648465286783731077661125911407053148687530924215425381486442853062651085932426422809031695803205160826298771112546701820565268125403044641640525341799809914362942288371181032972528996553748673764335271307231452905893080941417022782978869827242108962441415903754452235648321763190912332527695618984116912701759432549637781613011837997958610899783907396356250550211210877223025541517018277280287433342727704217592041981914279441601648984896710637098215108118352672364465278499108871286426136252195098886885976346716876456035480411705910089123665460851032154026704699872262357035511677232672841432940582915488358899143310946592514909625615693199823472732306442913210234247599335623816092355379230668962320345080984050760142174216521374346236632628958420026757219977954969511111720166843602720796830590001202932467304526212433042156096374805659430209263164235873583312540611359576069120320653775061641590840251249074907147955059847416944214762547768680289932752173193796821513793334412142634915373553479677707338275625653258094465440876814296424674721276567611844483003938883027760579764096564919636218187271949950739168982146851247266011858422779146095889383033504785859977598432706873861249616190337518843072905337647002981347129618401112078276434273570806953922228129525822413903127897770544224870447602030484274915907677635526459102841727349637071996781902143448539579771861124463993719446717253689081064352683075652217';

export async function generateAnonAadhaarProof(
  nullifierSeed: number,
  signal: string
): Promise<{
  anonAadhaarProof: AnonAadhaarProof;
  packedGroth16Proof: PackedGroth16Proof;
}> {
  const certificateDirName = __dirname + '/../../assets';
  const certificate = fs.readFileSync(certificateDirName + '/testCertificate.pem').toString();

  const anonAadhaarInitArgs: InitArgs = {
    wasmURL: artifactUrls.v2.wasm,
    zkeyURL: artifactUrls.v2.zkey,
    vkeyURL: artifactUrls.v2.vk,
    artifactsOrigin: ArtifactsOrigin.server
  };

  await init(anonAadhaarInitArgs);

  const args = await generateArgs({
    qrData: testQRData,
    certificateFile: certificate,
    nullifierSeed: nullifierSeed,
    signal: signal,
    fieldsToRevealArray: ['revealAgeAbove18', 'revealGender', 'revealPinCode', 'revealState']
  });

  const anonAadhaarCore = await prove(args);

  const anonAadhaarProof = anonAadhaarCore.proof;

  const packedGroth16Proof = packGroth16Proof(anonAadhaarProof.groth16Proof);

  return { anonAadhaarProof, packedGroth16Proof };
}
