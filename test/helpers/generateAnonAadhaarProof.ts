import {
  AnonAadhaarProof,
  ArtifactsOrigin,
  artifactUrls,
  generateArgs,
  init,
  InitArgs,
  PackedGroth16Proof,
  packGroth16Proof,
  prove
} from '@anon-aadhaar/core';
import fs from 'fs';

// Data generated in the anon-aadhaar repo, to have freshly signed data
// https://github.com/anon-aadhaar/anon-aadhaar/blob/main/packages/circuits/scripts/generateTestData.ts
const testQRData =
  '2114345875455589225035319522338913400308914412092591898897031015898123302049911943542583779594687843931540088456218737889875028806637008605986364718265788477527973683827412751594493047727832408016273136971900285971733860770350415214433755655486729898893716744171235926125277734219740356871074359280530920629726790109837046304995078448789458001936468258199879513093101890251425240131382227403418563274744824551003233779398867591363266648472797782704374390225164383348575620592569221299846721762337444015479609355467525113863962843977792793130806572930571157763799351331062881092754578068759396977868180999557633260715947362450494423542300588952112018879997444676386224080138376475633280321098205705349441560645712430949976957536980799262801358629336457540237005852166304378063722151712256329058914239074616208272285523615620473330524278485255829900712218017117933328105101705177871652325049688723737406388655863443020835355185924304070262596831858472028728976954557764449807921994128535259640204598823641117695808936872134786157240875619628855520935354411601948216488956619469342872318281348292354782382460316776027061287382393263430284726066663591029974430981689340361123663659288371461397851715463481574910037025931008985471599291992505077325744268762749272212767086784922693886517218886593664143741059826660823336644977020386465799602101564888648224410194304897401613063808391223441288642226483168992143781196672679941714735622179921377439705652211119516761887045717068835456561983193084704421408934605298910660749243452399570374441115287314042375029804971002984891724621343344864457734017459147738095760842231937147922639668990336355020003717917360339175352444416894378211448399669727960755138375406119216014702887995967989053276295835749266915711180629110718591132941185202339666387619581834994086927154030771647278494912403713384681793927765764373113334106208432464508870787207641636855444936772370944039582418032913029362790025535907974623314643600885258404940549142944407358561964331475848879757299475058260959978713446925778459027251186511600009241712702616238675815030719212018993603260154210990585666890596185284225133171133939418160646315658466714046783550036245853785986717108944839856860043053978399539553592736414543120625984429464432266100775857350881681730700426448308630320736619170017277833223019771162645440679515408175308418051974576066626096420350253337717185921296004822032868950477050389349689897571675043961370824810270443756808168267279353382304611425730389687267812072095419826776436767051357203676594349540172158877655160857317674830392754515237289999546240216907210734811031298382704675796983795629941676940583773796789407759010764191008450469516476350167168973514034608826655253392481766202013424818200850054556656305020916863159941293727796007710652048198564607460275146874177929324984052182207853065056604592952120656606690492258706893158916613460314436211335005641656050186883165434797728900622572191359110804552130007331320815307250328920540334368527386253629609019331805252429028866565784632616881786913666614042541735551446789235904684503190618797039769911712435333231043443934328344652893052708543245178193002001097168487544738505837762';

export async function generateAnonAadhaarProof(
  nullifierSeed: number,
  signal: string
): Promise<{
  anonAadhaarProof: AnonAadhaarProof;
  packedGroth16Proof: PackedGroth16Proof;
}> {
  const certificateDirName = __dirname + '/../../assets';
  const certificate = fs.readFileSync(certificateDirName + '/testCertificate.pem').toString();

  const anonAadhaarInitArgs: InitArgs = {
    wasmURL: artifactUrls.v2.wasm,
    zkeyURL: artifactUrls.v2.zkey,
    vkeyURL: artifactUrls.v2.vk,
    artifactsOrigin: ArtifactsOrigin.server
  };

  await init(anonAadhaarInitArgs);

  const args = await generateArgs({
    qrData: testQRData,
    certificateFile: certificate,
    nullifierSeed: nullifierSeed,
    signal: signal,
    fieldsToRevealArray: ['revealAgeAbove18', 'revealGender', 'revealPinCode', 'revealState']
  });

  const anonAadhaarCore = await prove(args);

  const anonAadhaarProof = anonAadhaarCore.proof;

  const packedGroth16Proof = packGroth16Proof(anonAadhaarProof.groth16Proof);

  return { anonAadhaarProof, packedGroth16Proof };
}
